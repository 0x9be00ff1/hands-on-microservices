# 一种微服务分层架构的技术栈选型

我们在[工具链](./rd-ops-toolchain.md)、[一种微服务的分层架构](./ms-architecture.md) 两小节中讨论了技术栈的需求。

在本节中，我们将具体讨论技术栈的选型。

你可能注意到，上一节的标题是“一种微服务的分层架构”，而这一节的标题是“一种微服务分层架构的技术栈选型”。

加上“一种”这个词是有意而为之，请不要怀疑我的语文水平:-)

"一种"强调的是：

- 微服务只是一种架构风格，他可以有N种不同的实现，上一节只介绍了其中一种。

- 每一种微服务架构的实现，也可以对应N种不同的技术栈选型。

那么，在这N^2种架构 + 技术栈的组合种，哪一种才是最好的？

不急着回答，我们先来看下这个：

> php is the best language for web programming.

这是PHP官方手册的原文，更多人更熟悉前5个单词，“PHP是全世界最好的语言”。

但加上后3个单词“for web programming”后，就变成了“PHP是web领域最好的语言”。

而我的观点(哪个架构更优) 与 PHP社区(关于语言优劣)的观点，是一致的：没有最好的语言(技术)，只有最适合具体场景的。

因此，我们只会针对各项场景，列出技术选型，而不会打“为什么A比B好的”口水战。

## 容器管理平台的技术选型

微服务架构下会对服务进行拆分，产生大量的服务实例。

容器化技术，可以实现环境隔离、快速部署，是微服务架构的基石。

Docker凭借“快速”、“可移植性”等特性""一战成名"，是单机或小规模应用部署的最佳选择

然而，在复杂的分布式部署场景中，"扩容"、"编排"、"故障恢复"等成为了"刚需"，“容器管理平台”应运而生。在这个赛道上，曾经出现过三个主流产品：

- swarm: Docker公司于2014年末推出的容器集群技术方案。尽管swarm是Docker公司的“亲儿子”、手握大量社区资源，但很快被Kubernetes超越。

- Kubernetes: 简称k8s，支持自动部署，扩展和管理容器化应用程序的开源系统。k8s借鉴了Google的Borg管理系统，自问世以来发展迅猛，当前已经成为了容器管理的事实标准。

- Marathon: 构建在[Apache Mesos]([Apache Mesos](http://mesos.apache.org/))集群上的一套容器集群管理软件。由于Mesos的部署存在门槛，Marathon项目的关注度并不高，社区也并不活跃。其上一个发布版本依然停留在2019年，已经近2年没有更新。

因此，我们"毫无争议"地选择k8s作为微服务架构下的容器管理平台。

除了容器管理平台，我们还需要镜像仓库存储应用的容器镜像，我们将使用Docker搭建私有镜像仓库。

## 微服务设施层的技术选型

设施层涉及较多的技术需求，技术选型如下：

| 需求               | 选型                        | 版本             |
| ---------------- | ------------------------- | -------------- |
| 开发框架             | Spring Boot               | 2.5.4          |
| RPC              | gRPC                      | 1.14.x         |
| 服务注册 / 发现 / 配置中心 | Nacos                     | 2.x            |
| 熔断 / 限流          | Resilience4j              | 1.7.1          |
| SQL数据库           | MySQL                     | 8.0.X          |
| No SQL数据库        | Redis                     | 6.2            |
| 消息队列             | RocketMQ                  | 4.9.1          |
| 日志               | Kafka + ELB               | 2.13 + 7.14.X  |
| 监控               | VictoriaMetrics + Grafana | 1.64.1 + 8.1.X |
| 链路追踪             | SkyWalking                | 8.7.0          |

## 
